"use strict";document.addEventListener("DOMContentLoaded",function(){let userID="";if(document.cookie.split(";").filter(function(item){return item.trim().indexOf("acceptlightning=")==0}).length){userID=JSON.parse(document.cookie.replace(/(?:(?:^|.*;\s*)acceptlightning\s*\=\s*([^;]*).*$)|^.*$/,"$1"))["userID"]}else{userID=generateRandomID();document.cookie="acceptlightning="+JSON.stringify({userID:userID})}const nextAdButton=document.getElementById("nextAdButton");nextAdButton.addEventListener("click",function(event){document.getElementById("a-ads").src+="";getNextAd(userID)});const adImg=document.getElementById("adImg");adImg.addEventListener("load",function(){populateUserBalance(userID);setTimeout(function(){nextAdButton.removeAttribute("disabled")},2e3)});adImg.addEventListener("error",function(){nextAdButton.removeAttribute("disabled")});adImg.addEventListener("click",function(){jsonrpc("adClick",{version:1,src:adImg.src})});populateUserBalance(userID);getNextAd(userID);let bolt11="";const tipMeButton=document.getElementById("tipMeButton");const tipMeModalBody=document.getElementById("tipMeModalBody");tipMeButton.addEventListener("click",async function(event){if(bolt11!=""){return}try{const invoiceResult=await invoice("any","tip",2400);const backOffTimeout=4e3;let pollCount=0;const getInvoicePoll=async function(invoiceLabel){if(bolt11===""){bolt11=invoiceResult["lightningResponse"]["bolt11"];QRCode.toDataURL(bolt11,function(error,qrCodeUrl){tipMeModalBody.innerHTML='<input type="text" value="'+bolt11+'"></input>'+'<img src="'+qrCodeUrl+'">'})}try{const getInvoiceResponse=await getInvoice(invoiceLabel);const paid=getInvoiceResponse["lightningResponse"]["invoices"][0]["status"];const expiresAt=getInvoiceResponse["lightningResponse"]["invoices"][0]["expires_at"];console.log("Paid:",paid,"Expires At: ",new Date(expiresAt*1e3));if(paid==="paid"){tipMeModalBody.innerHTML="Thank You!"}else{if((new Date).getTime()>=expiresAt*1e3){tipMeModalBody.innerHTML="Expired, refresh and try again :)"}else{await timeout(backOffTimeout);pollCount++;if(pollCount<11){getInvoicePoll(invoiceLabel)}}}}catch(error){if("jsonrpcerror"in error){document.getElementById("error").innerHTML+="Error "+error["method"]+": "+error["message"]+"<br>";document.getElementById("error").style.display="block"}}};getInvoicePoll(invoiceResult["invoiceResponse"]["invoiceLabel"])}catch(error){if("jsonrpcerror"in error){document.getElementById("error").innerHTML+="Error "+error["method"]+": "+error["message"]+"<br>";document.getElementById("error").style.display="block"}}});function generateRandomID(){const arr=new Uint32Array(1);window.crypto.getRandomValues(arr);return arr[0].toString()}function jsonrpc(method,params){const url="https://speedoflightning.com";return new Promise(function(resolve,reject){const xhr=new XMLHttpRequest;xhr.open("POST",url);xhr.setRequestHeader("Content-Type","application/json");const id=generateRandomID();xhr.onload=function(){if(xhr.status===200){const response=JSON.parse(xhr.responseText);if("result"in response){resolve(response["result"])}else if("error"in response&&"message"in response["error"]){reject({jsonrpcerror:"2.0",url:url,method:method,params:params,type:"lightning",message:response["error"]["message"]})}else{reject({jsonrpcerror:"2.0",url:url,method:method,params:params,type:"unknown",message:xhr.responseText})}}else{reject({jsonrpcerror:"2.0",url:url,method:method,params:params,type:"xhr.status",message:xhr.status})}};xhr.timeout=8e3;xhr.ontimeout=function(){reject({jsonrpcerror:"2.0",url:url,method:method,params:params,type:"timeout",message:"timeout"})};xhr.send(JSON.stringify({jsonrpc:"2.0",id:id,method:method,params:params}))})}async function getNextAd(userID){try{const getNextAdResponse=await jsonrpc("getNextAd",{version:1,userID:userID});if("captcha"in getNextAdResponse){document.getElementById("adContainer").style.display="none";document.getElementById("nonAdContainer").innerHTML=getNextAdResponse["captcha"];document.getElementById("nonAdContainer").style.display="block";document.getElementById("captchaButton").addEventListener("click",async function(){const checkboxes=document.getElementsByClassName("form-check-input");let answer="";for(let i=0;i<checkboxes.length;i++){answer+=checkboxes[i].id+"="+checkboxes[i].checked+","}const captchaResponse=await jsonrpc("captcha",{version:1,userID:userID,answer:answer});getNextAd(userID)})}else if("feeback"in getNextAdResponse){document.getElementById("adContainer").style.display="none";document.getElementById("nonAdContainer").innerHTML=getNextAdResponse["feeback"];document.getElementById("nonAdContainer").style.display="block";document.getElementById("feedbackButton").addEventListener("click",async function(){const answer=document.getElementById("feedbackTextArea").value;jsonrpc("feedback",{version:1,userID:userID,answer:answer});getNextAd(userID)})}else{document.getElementById("nonAdContainer").style.display="none";document.getElementById("adContainer").style.display="block";const nextAdButton=document.getElementById("nextAdButton");nextAdButton.setAttribute("disabled","");adImg.src=getNextAdResponse["img"];adImg.width=getNextAdResponse["width"];adImg.height=getNextAdResponse["height"];document.getElementById("adLink").href=getNextAdResponse["link"];populateAdReward(getNextAdResponse["reward"])}}catch(error){if("jsonrpcerror"in error){document.getElementById("error").innerHTML+="Error "+error["method"]+": "+error["message"]+"<br>";document.getElementById("error").style.display="block"}}}async function getUserBalance(userID){const getUserBalanceResponse=await jsonrpc("getUserBalance",{version:1,userID:userID});return getUserBalanceResponse["balance"]}async function populateUserBalance(userID){try{const balance=await getUserBalance(userID);const balanceSatoshis=parseInt(balance)*.001;if(balanceSatoshis==1){document.getElementById("balance").innerHTML=" "+balanceSatoshis+" satoshi"}else{document.getElementById("balance").innerHTML=" "+balanceSatoshis+" satoshis"}}catch(error){if("jsonrpcerror"in error){document.getElementById("error").innerHTML+="Error "+error["method"]+": "+error["message"]+"<br>";document.getElementById("error").style.display="block"}}}function populateAdReward(reward){const rewardSatoshis=parseInt(reward)*.001;if(rewardSatoshis==1){document.getElementById("reward").innerHTML=" "+rewardSatoshis+" satoshi"}else{document.getElementById("reward").innerHTML=" "+rewardSatoshis+" satoshis"}}async function invoice(msatoshi,description,expiry){const invoiceResponse=await jsonrpc("invoice",{version:1,msatoshi:msatoshi,description:description,expiry:expiry});const lightningResponse=await getLightningResponse(invoiceResponse["lightningRequestID"]);return{invoiceResponse:invoiceResponse,lightningResponse:lightningResponse}}async function getInvoice(invoiceLabel){const getInvoiceResponse=await jsonrpc("getInvoice",{version:1,invoiceLabel:invoiceLabel});const lightningResponse=await getLightningResponse(getInvoiceResponse["lightningRequestID"]);return{getInvoiceResponse:getInvoiceResponse,lightningResponse:lightningResponse}}function timeout(milliseconds){return new Promise(function(resolve){setTimeout(resolve,milliseconds)})}async function getLightningResponse(lightningRequestID){const response=await jsonrpc("getLightningResponse",{version:1,lightningRequestID:lightningRequestID});if("responseStatus"in response&&response["responseStatus"]==="Pending"){await timeout(5e3);console.log(response);return getLightningResponse(lightningRequestID)}else{return response}}});
